"use strict";(self.webpackChunklhtp=self.webpackChunklhtp||[]).push([[77192],{28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>o});var s=t(96540);const a={},i=s.createContext(a);function r(e){const n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),s.createElement(i.Provider,{value:n},e.children)}},35827:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"c-and-net/database-basics/5-3-0-13-saving-objects-in-the-database","title":"\ud83d\udcd3 5.3.0.13 Saving Objects in the Database","description":"In the last lesson, we wrote and tested a method to override Equals(). Now we\'re ready to write a method for saving Items to the database.","source":"@site/versioned_docs/version-WIP/c-and-net/3_database-basics/3-3-0-13-saving-objects-in-the-database.md","sourceDirName":"c-and-net/3_database-basics","slug":"/c-and-net/database-basics/5-3-0-13-saving-objects-in-the-database","permalink":"/WIP/c-and-net/database-basics/5-3-0-13-saving-objects-in-the-database","draft":false,"unlisted":false,"tags":[],"version":"WIP","frontMatter":{"title":"\ud83d\udcd3 5.3.0.13 Saving Objects in the Database","day":"weekend","id":"5-3-0-13-saving-objects-in-the-database","hide_table_of_contents":true},"sidebar":"c-and-net","previous":{"title":"\ud83d\udcd3 5.3.0.12 Overriding Equals and GetHashCode","permalink":"/WIP/c-and-net/database-basics/5-3-0-12-overriding-equals-and-gethashcode"},"next":{"title":"\ud83d\udcd3 5.3.0.14 Finding Objects in the Database","permalink":"/WIP/c-and-net/database-basics/5-3-0-14-finding-objects-in-the-database"}}');var a=t(74848),i=t(28453);const r={title:"\ud83d\udcd3 5.3.0.13 Saving Objects in the Database",day:"weekend",id:"5-3-0-13-saving-objects-in-the-database",hide_table_of_contents:!0},o=void 0,d={},c=[{value:"Saving Objects in the Database",id:"saving-objects-in-the-database",level:2},{value:"Testing the Save() Method",id:"testing-the-save-method",level:3},{value:"Creating New Database Entries",id:"creating-new-database-entries",level:3},{value:"Parameter Placeholders",id:"parameter-placeholders",level:4},{value:"Passing a <code>MySqlParameter</code> Object Into a <code>SqlCommand</code>",id:"passing-a-mysqlparameter-object-into-a-sqlcommand",level:4},{value:"Executing a Non-Query Command",id:"executing-a-non-query-command",level:4},{value:"Returning an <code>id</code> from the Database",id:"returning-an-id-from-the-database",level:3},{value:"Overriding <code>Equals()</code> Method Update",id:"overriding-equals-method-update",level:3},{value:"Updating Tests",id:"updating-tests",level:3},{value:"Updating Controller Logic",id:"updating-controller-logic",level:3}];function l(e){const n={a:"a",code:"code",div:"div",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(n.p,{children:["In the last lesson, we wrote and tested a method to override ",(0,a.jsx)(n.code,{children:"Equals()"}),". Now we're ready to write a method for saving ",(0,a.jsx)(n.code,{children:"Item"}),"s to the database."]}),"\n",(0,a.jsx)(n.h2,{id:"saving-objects-in-the-database",children:"Saving Objects in the Database"}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.h3,{id:"testing-the-save-method",children:"Testing the Save() Method"}),"\n",(0,a.jsxs)(n.p,{children:["Let's start by adding an empty ",(0,a.jsx)(n.code,{children:"Save()"})," method to our ",(0,a.jsx)(n.code,{children:"Item"})," class. It will return type ",(0,a.jsx)(n.code,{children:"void"})," because adding a database entry doesn't need to return a value."]}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Models/Item.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"...\n\n  public void Save()\n  {\n  }\n\n...\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now let's write a test:"}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList.Tests/ModelTests/ItemTests.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'...\n\n  [TestMethod]\n  public void Save_SavesToDatabase_ItemList()\n  {\n    //Arrange\n    Item testItem = new Item("Mow the lawn");\n\n    //Act\n    testItem.Save();\n    List<Item> result = Item.GetAll();\n    List<Item> testList = new List<Item>{testItem};\n\n    //Assert\n    CollectionAssert.AreEqual(testList, result);\n  }\n\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Our test is straightforward. We should be able to instantiate a new ",(0,a.jsx)(n.code,{children:"Item"})," and save it to the database. Then we should be able to use our ",(0,a.jsx)(n.code,{children:"GetAll()"})," method to verify that it's been saved. Note that we are asserting that our ",(0,a.jsx)(n.code,{children:"testList"})," and our ",(0,a.jsx)(n.code,{children:"result"})," are the same. We are able to do this because we overrode the ",(0,a.jsx)(n.code,{children:"Equals()"})," method."]}),"\n",(0,a.jsx)(n.p,{children:"Run this test and verify that it fails."}),"\n",(0,a.jsx)(n.h3,{id:"creating-new-database-entries",children:"Creating New Database Entries"}),"\n",(0,a.jsxs)(n.p,{children:["Now let's add code to ",(0,a.jsx)(n.code,{children:"Save()"})," to interact with our database."]}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Models/Item.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'public void Save()\n{\n  MySqlConnection conn = new MySqlConnection(DBConfiguration.ConnectionString);\n  conn.Open();\n  \n  MySqlCommand cmd = conn.CreateCommand() as MySqlCommand;\n\n  // Begin new code\n\n  cmd.CommandText = "INSERT INTO items (description) VALUES (@ItemDescription);";\n  MySqlParameter param = new MySqlParameter();\n  param.ParameterName = "@ItemDescription";\n  param.Value = this.Description;\n  cmd.Parameters.Add(param);    \n  cmd.ExecuteNonQuery();\n  // Id = cmd.LastInsertedId;\n\n  // End new code\n\n  conn.Close();\n  if (conn != null)\n  {\n    conn.Dispose();\n  }\n}\n\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The beginning and end of this method should look familiar. We start by opening a connection and instantiating a ",(0,a.jsx)(n.code,{children:"MySqlCommand"}),". We end by closing our connection."]}),"\n",(0,a.jsxs)(n.p,{children:["Let's take a closer look at the code in the new code section above. This starts with ",(0,a.jsx)(n.code,{children:"// Begin new code"})," and ends with ",(0,a.jsx)(n.code,{children:"// End new code"}),"."]}),"\n",(0,a.jsx)(n.h4,{id:"parameter-placeholders",children:"Parameter Placeholders"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'cmd.CommandText = "INSERT INTO items (description) VALUES (@ItemDescription);";\n'})}),"\n",(0,a.jsxs)(n.p,{children:["We pass in an ",(0,a.jsx)(n.code,{children:"INSERT"})," SQL command into ",(0,a.jsx)(n.code,{children:"cmd.CommandText"}),". There's a new wrinkle here: we pass in a ",(0,a.jsx)(n.strong,{children:"parameter placeholder"})," called ",(0,a.jsx)(n.code,{children:"@ItemDescription"})," into the SQL statement. We want to use parameter placeholders whenever we are passing along data that a user enters. Information stored to a parameter is treated as field data and not part of the SQL statement, which helps to protect our application from a malicious attack called ",(0,a.jsx)(n.a,{href:"http://en.wikipedia.org/wiki/SQL_injection",children:"SQL injection"}),", which is illustrated in ",(0,a.jsx)(n.a,{href:"https://xkcd.com/327/",children:"this comic"}),"."]}),"\n",(0,a.jsxs)(n.p,{children:["The placeholder ",(0,a.jsx)(n.code,{children:"@ItemDescription"})," will be replaced with actual data from the user when the ",(0,a.jsx)(n.code,{children:"MySqlCommand"})," executes. Parameter placeholders need the ",(0,a.jsx)(n.code,{children:"@"})," symbol prefixing the name. You can read more about how parameters work in MySQL ",(0,a.jsx)(n.a,{href:"https://dev.mysql.com/doc/connector-net/en/connector-net-tutorials-parameters.html",children:"here"}),"."]}),"\n",(0,a.jsxs)(n.h4,{id:"passing-a-mysqlparameter-object-into-a-sqlcommand",children:["Passing a ",(0,a.jsx)(n.code,{children:"MySqlParameter"})," Object Into a ",(0,a.jsx)(n.code,{children:"SqlCommand"})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'MySqlParameter param = new MySqlParameter();\nparam.ParameterName = "@ItemDescription";\nparam.Value = this.Description;\ncmd.Parameters.Add(param);\n'})}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["We create a ",(0,a.jsx)(n.code,{children:"MySqlParameter"})," object for each parameter required in our ",(0,a.jsx)(n.code,{children:"MySqlCommand"}),". The ",(0,a.jsx)(n.code,{children:"ParameterName"})," must match the parameter in the command string. The ",(0,a.jsx)(n.code,{children:"Value"})," is what will replace the parameter in the command string when it is executed."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["We define the ",(0,a.jsx)(n.code,{children:"ParameterName"})," property of ",(0,a.jsx)(n.code,{children:"param"})," as ",(0,a.jsx)(n.code,{children:"@ItemDescription"}),", matching the parameter used in our SQL command ",(0,a.jsx)(n.code,{children:'"INSERT INTO items (description) VALUES (@ItemDescription);"'})," exactly."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["We define the ",(0,a.jsx)(n.code,{children:"Value"})," property of ",(0,a.jsx)(n.code,{children:"param"})," as ",(0,a.jsx)(n.code,{children:"this.Description"}),". This refers to the auto-implemented ",(0,a.jsx)(n.code,{children:"Description"})," property of the ",(0,a.jsx)(n.code,{children:"Item"})," we're saving."]}),"\n"]}),"\n",(0,a.jsxs)(n.li,{children:["\n",(0,a.jsxs)(n.p,{children:["We pass the ",(0,a.jsx)(n.code,{children:"param"})," into the ",(0,a.jsx)(n.code,{children:"MySqlCommand"}),"'s ",(0,a.jsx)(n.code,{children:"Parameters"})," property using ",(0,a.jsx)(n.code,{children:"Add()"}),". If we had more parameters to add, we would need to ",(0,a.jsx)(n.code,{children:"Add()"})," each one."]}),"\n"]}),"\n"]}),"\n",(0,a.jsxs)(n.p,{children:["This may seem confusing, but what we're essentially doing here is using an object to say the ",(0,a.jsx)(n.code,{children:"@ItemDescription"})," in our ",(0,a.jsx)(n.code,{children:"cmd.CommandText"})," equals ",(0,a.jsx)(n.code,{children:"this.Description"}),". There are simpler ways to do this, but for now we're doing it the long way as a demonstration. These four lines could all be replaced by this one line:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'cmd.Parameters.AddWithValue("@ItemDescription", this.Description);\n'})}),"\n",(0,a.jsx)(n.h4,{id:"executing-a-non-query-command",children:"Executing a Non-Query Command"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"cmd.ExecuteNonQuery();\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Finally, we call ",(0,a.jsx)(n.code,{children:"ExecuteNonQuery()"})," on our ",(0,a.jsx)(n.code,{children:"cmd"})," object to execute the SQL command."]}),"\n",(0,a.jsxs)(n.p,{children:["We only need the code up to this line in order to successfully save a new row in the database. In fact, we can run our tests and they will all pass. However, there's one more important thing we need to do so our ",(0,a.jsx)(n.code,{children:"Save()"})," method is fully integrated into our application."]}),"\n",(0,a.jsxs)(n.h3,{id:"returning-an-id-from-the-database",children:["Returning an ",(0,a.jsx)(n.code,{children:"id"})," from the Database"]}),"\n",(0,a.jsx)(n.p,{children:"The following line is currently commented out in our method:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"Id = cmd.LastInsertedId;\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Our method will correctly save ",(0,a.jsx)(n.code,{children:"Item"}),"s without the line above. When an ",(0,a.jsx)(n.code,{children:"Item"})," is saved, our database will automatically assign an ",(0,a.jsx)(n.code,{children:"id"})," to it. However, there's a big problem. Our application doesn't know about this ",(0,a.jsx)(n.code,{children:"id"})," value unless we add the line of code above. The line is very simple: it states that we need to set the ",(0,a.jsx)(n.code,{children:"Item"}),"'s ",(0,a.jsx)(n.code,{children:"Id"})," property equal to the value of the ",(0,a.jsx)(n.code,{children:"id"})," of the new row in our database. Fortunately, our ",(0,a.jsx)(n.code,{children:"MySqlCommand"})," object has a ",(0,a.jsx)(n.code,{children:"LastInsertedId"})," property which we can assign to the ",(0,a.jsx)(n.code,{children:"Item"}),"'s ",(0,a.jsx)(n.code,{children:"Id"})," property. This ensures that the ID property for an item is the same both in our application and our database."]}),"\n",(0,a.jsx)(n.p,{children:"If we uncomment the line of code above and run our tests again, the compiler will throw an error:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Property or indexer 'Item.Id' cannot be assigned to -- it is read only\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Fortunately, this is a very clear error. Our ",(0,a.jsx)(n.code,{children:"Id"})," property is currently only read-only. We need to add a setter to our auto-implemented property ",(0,a.jsx)(n.code,{children:"Id"}),":"]}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Models/Item.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"public int Id { get; set; }\n"})}),"\n",(0,a.jsx)(n.p,{children:"We'll get a new error when we run our tests:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"Cannot implicitly convert type 'long' to 'int'. An explicit conversion exists (are you missing a cast?)\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This error occurs because the ",(0,a.jsx)(n.code,{children:"MySqlCommand"})," property called ",(0,a.jsx)(n.code,{children:"LastInsertedId"})," returns a value of the type ",(0,a.jsx)(n.code,{children:"long"}),". A ",(0,a.jsx)(n.code,{children:"long"})," element is a piece of 64-bit data while an ",(0,a.jsx)(n.code,{children:"int"})," is 32-bit."]}),"\n",(0,a.jsxs)(n.p,{children:["To fix this issue, we'll use an ",(0,a.jsx)(n.strong,{children:"explicit cast"}),", also known as an ",(0,a.jsx)(n.strong,{children:"explicit conversion"}),", to turn this ",(0,a.jsx)(n.code,{children:"long"})," back into an ",(0,a.jsx)(n.code,{children:"int"}),". Remember that explicitly casting or converting data will force this ",(0,a.jsx)(n.code,{children:"long"})," into a new data type. We should only ever do this when we're sure we won't lose data in the process."]}),"\n",(0,a.jsxs)(n.p,{children:["For the applications we make, the length of the id will not exceed the limits of a 32-bit ",(0,a.jsx)(n.code,{children:"int"}),". Instead of refactoring our ",(0,a.jsx)(n.code,{children:"Item"})," class to use ",(0,a.jsx)(n.code,{children:"long"})," data types for our ",(0,a.jsx)(n.code,{children:"Id"})," properties, we'll use explicit conversion to turn them into ",(0,a.jsx)(n.code,{children:"int"}),"s."]}),"\n",(0,a.jsx)(n.p,{children:"We just need to tweak this line of code in our method:"}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Models/Item.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"Id = (int) cmd.LastInsertedId;\n"})}),"\n",(0,a.jsxs)(n.p,{children:["We add ",(0,a.jsx)(n.code,{children:"(int)"}),", which explicitly converts the ",(0,a.jsx)(n.code,{children:"LastInsertedId"})," property into an ",(0,a.jsx)(n.code,{children:"int"}),". Now our ",(0,a.jsx)(n.code,{children:"Save()"})," method correctly saves an ",(0,a.jsx)(n.code,{children:"Item"})," to the database and sets the ",(0,a.jsx)(n.code,{children:"Item"}),"'s ",(0,a.jsx)(n.code,{children:"Id"})," property to the database-assigned id value."]}),"\n",(0,a.jsxs)(n.h3,{id:"overriding-equals-method-update",children:["Overriding ",(0,a.jsx)(n.code,{children:"Equals()"})," Method Update"]}),"\n",(0,a.jsxs)(n.p,{children:["Our tests will pass as expected but our method for overriding equality is no longer accurate. We should always ensure that all properties are equal when comparing two objects. In this case, that means we should also make sure that the objects we are comparing have the same ",(0,a.jsx)(n.code,{children:"Id"})," property. Let's update the method now:"]}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Models/Item.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:"...\n\n  public override bool Equals(System.Object otherItem)\n  {\n    if (!(otherItem is Item))\n    {\n      return false;\n    }\n    else\n    {\n      Item newItem = (Item) otherItem;\n      bool idEquality = (this.Id == newItem.Id);\n      bool descriptionEquality = (this.Description == newItem.Description);\n      return (idEquality && descriptionEquality);\n    }\n  }\n\n...\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Whenever we add a new property to our application, we should make sure that we update our ",(0,a.jsx)(n.code,{children:"Equals()"})," method accordingly."]}),"\n",(0,a.jsx)(n.h3,{id:"updating-tests",children:"Updating Tests"}),"\n",(0,a.jsx)(n.p,{children:"We can also uncomment one of our previously commented-out tests and make a small update to get it to pass:"}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList.Tests/ModelTests/ItemTests.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'\n  [TestMethod]\n  public void GetAll_ReturnsItems_ItemList()\n  {\n    //Arrange\n    string description01 = "Walk the dog";\n    string description02 = "Wash the dishes";\n    Item newItem1 = new Item(description01);\n    newItem1.Save(); // New code\n    Item newItem2 = new Item(description02);\n    newItem2.Save(); // New code\n    List<Item> newList = new List<Item> { newItem1, newItem2 };\n\n    //Act\n    List<Item> result = Item.GetAll();\n\n    //Assert\n    CollectionAssert.AreEqual(newList, result);\n  }\n\n...\n'})}),"\n",(0,a.jsxs)(n.p,{children:["We just need to call ",(0,a.jsx)(n.code,{children:"Save()"})," after creating each new ",(0,a.jsx)(n.code,{children:"Item"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"updating-controller-logic",children:"Updating Controller Logic"}),"\n",(0,a.jsxs)(n.p,{children:["Next, let's make sure to call our new ",(0,a.jsx)(n.code,{children:"Save()"})," method after we create new instances of ",(0,a.jsx)(n.code,{children:"Item"})," objects in the ",(0,a.jsx)(n.code,{children:"CategoriesController"}),":"]}),"\n",(0,a.jsx)(n.div,{className:"filename",children:"ToDoList/Controllers/CategoriesController.cs"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-csharp",children:'...\n\n[HttpPost("/categories/{categoryId}/items")]\npublic ActionResult Create(int categoryId, string itemDescription)\n{\n  Dictionary<string, object> model = new Dictionary<string, object>();\n  Category foundCategory = Category.Find(categoryId);\n  Item newItem = new Item(itemDescription);\n  newItem.Save();    // New code\n  foundCategory.AddItem(newItem);\n  List<Item> categoryItems = foundCategory.Items;\n  model.Add("items", categoryItems);\n  model.Add("category", foundCategory);\n  return View("Show", model);\n}\n\n...\n'})}),"\n",(0,a.jsxs)(n.p,{children:["In this lesson, we've added a ",(0,a.jsx)(n.code,{children:"Save()"})," method that allows us to add ",(0,a.jsx)(n.code,{children:"Item"}),"s to the database. Our method returns a database-assigned id so that we can ensure that ",(0,a.jsx)(n.code,{children:"Item"}),"s in our application always correctly match the corresponding rows in the database. We had to use an explicit cast for this to work correctly. Finally, we updated our ",(0,a.jsx)(n.code,{children:"Equals()"})," method and made some small changes to our application so it can fully utilize our new ",(0,a.jsx)(n.code,{children:"Save()"})," method."]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}}}]);